# NFS 서버 연동 및 PV 설정 변경 로그

## 1. 개요
MySQL 데이터의 안정적인 저장과 노드 간 유연한 접근을 위해 로컬 `hostPath` 방식에서 NFS(Network File System) 방식으로 스토리지를 변경했습니다.
*   **NFS 서버 IP**: 172.100.100.100
*   **대상 리소스**: `mysql-pv-0`, `mysql-pv-1`, `mysql-pv-2`

## 2. 변경된 파일 (workspace/k8s-project/mysql/mysql-pv.yaml)
기존의 `hostPath` 필드를 `nfs` 필드로 교체했습니다.

**변경 전:**
```yaml
hostPath:
  path: /mnt/mysql-data-0
```

**변경 후:**
```yaml
nfs:
  server: 172.100.100.100
  path: /srv/nfs/mysql-0 # 각 PV마다 경로 구분 (mysql-1, mysql-2)
```

## 3. 사전 요구 사항 (매우 중요)

### 3-1. NFS 서버 (172.100.100.100) 설정
NFS 서버에서 데이터를 저장할 디렉토리를 만들고 공유 설정을 해야 합니다.

```bash
# 1. 디렉토리 생성
sudo mkdir -p /srv/nfs/mysql-0
sudo mkdir -p /srv/nfs/mysql-1
sudo mkdir -p /srv/nfs/mysql-2

# 2. 권한 설정 (MySQL은 보통 uid 999 또는 27을 사용하므로, 넉넉하게 777로 하거나 소유권을 맞춰야 함)
# 테스트용으로는 777 권한이 가장 확실함
sudo chmod -R 777 /srv/nfs/

# 3. /etc/exports 파일 설정
# (모든 네트워크 대역 허용 예시, 보안상 IP 제한 권장)
echo "/srv/nfs/mysql-0 *(rw,sync,no_subtree_check,no_root_squash)" | sudo tee -a /etc/exports
echo "/srv/nfs/mysql-1 *(rw,sync,no_subtree_check,no_root_squash)" | sudo tee -a /etc/exports
echo "/srv/nfs/mysql-2 *(rw,sync,no_subtree_check,no_root_squash)" | sudo tee -a /etc/exports

# 4. NFS 서비스 재시작
sudo exportfs -a
sudo systemctl restart nfs-kernel-server
```

### 3-2. Kubernetes 모든 노드 (Master & Workers) 설정
Kubernetes 노드들이 NFS 볼륨을 마운트하려면 `nfs-common` 패키지가 반드시 설치되어 있어야 합니다.

```bash
# 우분투/데비안 기준
sudo apt-get update
sudo apt-get install -y nfs-common
```

## 4. 적용 방법
기존 PV를 삭제하고 새로 생성해야 변경된 설정이 적용됩니다. (데이터 유실 주의: 기존 로컬 데이터는 NFS로 자동 복사되지 않습니다.)

```bash
# 1. 기존 리소스 삭제 (순서 중요)
kubectl delete innodbcluster mysql-cluster
kubectl delete pvc --all # 주의! 모든 PVC 삭제
kubectl delete pv mysql-pv-0 mysql-pv-1 mysql-pv-2

# 2. 변경된 PV 생성
kubectl apply -f workspace/k8s-project/mysql/mysql-pv.yaml

# 3. 클러스터 재생성 (PVC는 자동으로 PV와 바인딩됨)
kubectl apply -f workspace/k8s-project/mysql/mysql-cluster.yaml
```

## 5. 트러블슈팅
*   **Pending 상태**: PV가 `Bound` 되지 않고 `Pending` 상태라면, PV의 `storageClassName`(`manual`)과 PVC(혹은 `mysql-cluster.yaml`의 템플릿)의 `storageClassName`이 일치하는지 확인하세요.
*   **Mount 실패**: Pod 이벤트(`kubectl describe pod ...`)에서 `mount failed` 에러가 보이면, 해당 워커 노드에 `nfs-common`이 설치되어 있는지, NFS 서버 방화벽(2049 포트)이 열려 있는지 확인하세요.
